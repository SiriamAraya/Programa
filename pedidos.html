<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="css/estilos.css">
  <title>Ver Pedidos</title>
 
</head>
<body>
  <nav class="menu">
    <a href="index.html">Inicio</a>
    <a href="agregar.html">Agregar Pedido</a>
    <a href="pedidos.html">Agregar al Pedido</a>
    <a href="pagos.html">Registrar Pago</a>
    <a href="cierre.html">Hacer Cierre</a>
  </nav>
  <h2>Pedidos Realizados</h2>
  <table>
    <thead>
      <tr>
        <th>Cliente</th>
        <th>Productos</th>
        <th>Total</th>
        <th>Acci√≥n</th>
      </tr>
    </thead>
    <tbody id="listaPedidos"></tbody>
  </table>

<script>
  fetch('http://localhost:3000/pedidos')
    .then(res => res.json())
    .then(pedidos => {
      const tbody = document.getElementById("listaPedidos");

      // Agrupar por cliente
      const pedidosPorCliente = {};
      pedidos.forEach(pedido => {
        if (!pedidosPorCliente[pedido.cliente]) {
          pedidosPorCliente[pedido.cliente] = { productos: [], subtotal: 0 };
        }

        pedido.productos.forEach(prod => {
          const existente = pedidosPorCliente[pedido.cliente].productos.find(p => p.nombre === prod.nombre);
          if (existente) {
            existente.cantidad += prod.cantidad;
          } else {
            pedidosPorCliente[pedido.cliente].productos.push({ ...prod });
          }
        });

        pedidosPorCliente[pedido.cliente].subtotal += pedido.subtotal;
      });

      // Mostrar tabla
      if (Object.keys(pedidosPorCliente).length === 0) {
        tbody.innerHTML = '<tr><td colspan="4">No hay pedidos registrados.</td></tr>';
      } else {
        for (const cliente in pedidosPorCliente) {
          const items = pedidosPorCliente[cliente];
          let productosHTML = "<ul>";
          items.productos.forEach(prod => {
            const subtotal = prod.cantidad * prod.precio;
            productosHTML += `<li>${prod.cantidad} x ${prod.nombre} = $${subtotal.toFixed(2)}</li>`;
          });
          productosHTML += "</ul>";

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${cliente}</td>
            <td>${productosHTML}</td>
            <td>$${items.subtotal.toFixed(2)}</td>
            <td><button onclick="editarPedido('${cliente}')">Agregar al Pedido</button></td>
          `;
          tbody.appendChild(tr);
        }
      }

      // Guardar en memoria para editar
      window.pedidosCliente = pedidosPorCliente;
    })
    .catch(err => {
      document.getElementById("listaPedidos").innerHTML = `<tr><td colspan="4">Error al cargar pedidos</td></tr>`;
      console.error("Error:", err);
    });

  function editarPedido(cliente) {
    const pedido = window.pedidosCliente[cliente];
    if (pedido) {
      localStorage.setItem("pedidoEditar", JSON.stringify({
        cliente,
        productos: pedido.productos
      }));
      window.location.href = "agregar.html";
    }
  }
</script>
</body>
</html>
