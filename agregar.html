<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Agregar Pedido</title>
  <link rel="stylesheet" href="css/estilos.css">
</head>
<body>
  <nav class="menu">
  <a href="index.html">Inicio</a>
  <a href="agregar.html">Agregar Pedido</a>
  <a href="pedidos.html">Agregar al Pedido</a>
  <a href="pagos.html">Registrar Pago</a>
  <a href="cierre.html">Hacer Cierre</a>
</nav>
  <h3>Agregar Pedido</h3>
<input type="text" id="clienteInput" placeholder="Nombre del cliente" />
<select id="productoSelect">
  <option value="Hamburguesa" data-precio="5">Hamburguesa - $5</option>
  <option value="Papas" data-precio="4">Papas - $4</option>
  <option value="Refresco" data-precio="2">Refresco - $2</option>
</select>
<input type="number" id="cantidadInput" min="1" value="1" />

  <button onclick="agregarProducto()">Agregar al Pedido</button>

  <h2>Resumen del Pedido</h2>
  <ul id="resumenLista"></ul>
  <p>Total: $<span id="totalSpan">0</span></p>

  <button onclick="guardarPedido()">Guardar Pedido</button>

  <script>
    let productosPedido = [];
    let clienteEditando = null;

    // Cargar pedido si venimos de pedidos.html
    const pedidoEditar = JSON.parse(localStorage.getItem("pedidoEditar"));
    if (pedidoEditar) {
      clienteEditando = pedidoEditar.cliente;
      document.getElementById("clienteInput").value = clienteEditando;
      productosPedido = pedidoEditar.productos;
      localStorage.removeItem("pedidoEditar");
      actualizarResumen();
    }

    function agregarProducto() {
      const productoSelect = document.getElementById("productoSelect");
      const nombre = productoSelect.value;
      const precio = parseFloat(productoSelect.options[productoSelect.selectedIndex].dataset.precio);
      const cantidad = parseInt(document.getElementById("cantidadInput").value);

      if (!nombre || isNaN(cantidad) || cantidad <= 0) {
        alert("Seleccione un producto vÃ¡lido y cantidad mayor a 0.");
        return;
      }

      const existente = productosPedido.find(p => p.nombre === nombre);
      if (existente) {
        existente.cantidad += cantidad;
      } else {
        productosPedido.push({ nombre, cantidad, precio });
      }

      actualizarResumen();
    }

    function actualizarResumen() {
      const lista = document.getElementById("resumenLista");
      const totalSpan = document.getElementById("totalSpan");
      lista.innerHTML = "";
      let total = 0;

      productosPedido.forEach(p => {
        const subtotal = p.precio * p.cantidad;
        total += subtotal;
        const li = document.createElement("li");
        li.textContent = `${p.cantidad} x ${p.nombre} = $${subtotal.toFixed(2)}`;
        lista.appendChild(li);
      });

      totalSpan.textContent = total.toFixed(2);
    }

    function guardarPedido() {
      const cliente = document.getElementById("clienteInput").value.trim();
      if (!cliente) {
        alert("Debe ingresar un nombre de cliente.");
        return;
      }
      if (productosPedido.length === 0) {
        alert("Debe agregar al menos un producto.");
        return;
      }

      const subtotal = productosPedido.reduce((sum, p) => sum + p.cantidad * p.precio, 0);
      const nuevoPedido = {
        cliente,
        productos: productosPedido,
        subtotal,
        fechaPago: null
      };

      fetch('http://localhost:3000/pedidos', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(nuevoPedido)
      })
      .then(res => {
        if (!res.ok) throw new Error("Error al guardar pedido");
        alert("Pedido guardado correctamente");
        window.location.href = "pedidos.html";
      })
      .catch(err => {
        alert("Hubo un error al guardar el pedido");
        console.error(err);
      });
    }
  </script>
</body>
</html>
